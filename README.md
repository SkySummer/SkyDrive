# ☁️ SkyDrive

SkyDrive 是基于现代 C++20 开发的高性能云盘服务器，采用 epoll 事件驱动 + 线程池任务调度架构，支持用户认证、文件上传下载、目录索引、动态模板渲染和多层安全防护，具备完善的日志系统和模块化配置能力。

## ✨ 核心功能

### 🚄 高并发网络处理
- 基于 epoll 边缘触发，实现高效率网络事件处理。

### 🧰 线程池任务调度
- 使用线程池异步处理客户端请求，自动分发任务并捕获异常，提升系统资源利用率与响应速度。

### 🔐 用户认证与会话管理
- 支持用户注册、登录、登出及密码修改；
- 使用加盐哈希（SHA256）安全存储用户密码；
- 通过 Session ID 搭配 HttpOnly Cookie 实现安全会话管理。

### 📦 文件管理与云盘功能
- 支持多文件上传，带有上传进度提示；
- 支持文件下载和动态生成目录索引；
- 自动识别常见文件类型并设置 MIME 类型；
- 基于模板的动态页面渲染，按用户状态展示对应视图。

### 📝 HTTP 协议处理
- 解析 HTTP 请求行、头部与消息体；
- 构建灵活的响应，支持状态码、头部字段、自定义错误页、JS 提示与重定向等功能。

### 📊 分级日志系统
- 支持 DEBUG / INFO / WARNING / ERROR 四级日志记录；
- 日志按日期自动轮换，便于追踪与管理；
- 记录详细客户端信息，辅助开发与调试。

### ⚙️ 模块化设计与可配置性
- 通过 `config.ini` 灵活配置端口、线程数、日志等级、Linger 模式、文件目录等参数；
- 项目结构清晰，模块职责分明，便于维护与扩展。

### 🛡️ 安全防护机制
- 路径规范化与访问安全检查，防止目录遍历等攻击；
- 文件名合法性校验；
- 支持 Linger 模式，安全关闭 TCP 连接。

### 🚦 信号处理支持
- 支持通过系统信号实现服务器的平滑关闭。

## 📂 项目架构

```
SkyDrive/
├── data/               # 数据目录
│   ├── files/          # 云盘存储文件
│   └── users.dat       # 用户账号密码数据
│
├── docs/               # 项目文档
│   ├── core/           # 核心模块文档
│   ├── images/         # 图片资源
│   └── utils/          # 工具模块文档
│
├── include/            # 头文件
│   ├── core/           # 核心类
│   ├── user/           # 用户相关类
│   └── utils/          # 工具类
│
├── src/                # 源码目录
│   ├── core/           # 核心模块
│   ├── user/           # 用户模块
│   └── utils/          # 工具模块
│
├── static/             # 静态资源目录
├── templates/          # 页面模板目录
├── CMakeLists.txt      # 构建配置文件
├── config.ini          # 服务器配置文件
├── LICENSE             # 开源许可证
├── main.cpp            # 主程序入口
└── README.md           # 项目说明文档
```

## 🛠️ 构建指南

### 依赖项
- g++ (>= 13)
- CMake (>= 3.13)

### 编译流程
```bash
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)
```

### 启动服务
```bash
./SkyDrive
```

服务监听 `config.ini` 中配置的端口（默认为 8080）。

## ⚙️ 配置示例

编辑 `config.ini` 自定义服务器参数：

```ini
# SkyDrive 配置文件

# 监听端口
port = 8080

# 日志等级（DEBUG/INFO/WARNING/ERROR）
log_level = DEBUG

# 线程池大小
thread_count = 4

# 是否启用 SO_LINGER 模式
linger = false

# 静态文件目录（相对项目根目录）
static_dir = static

# 云盘文件目录（相对 data/ 目录）
drive_dir = files

# 用户信息文件（相对 data/ 目录）
user_file = users.dat
```

## 🌟 功能示例

### 🏠 首页展示
访问 `http://localhost:port/` 返回欢迎页面，未登录用户显示注册 / 登录入口，已登录用户显示进入网盘的按钮。

### 🔑 注册与登录

#### 注册界面
访问 `http://localhost:port/register` 填写用户名与密码注册账户。注册成功后自动登录跳转至网盘页面。

#### 登录界面
访问 `http://localhost:port/login` 填写已有账户信息登录。

#### 修改密码
访问 `http://localhost:port/reset-password` 可修改当前账户密码，操作成功后刷新登录状态。

#### 用户登出
点击导航栏“退出”按钮清除会话信息并返回首页。

### 📁 网盘文件操作

#### 目录索引浏览
访问 `http://localhost:port/files/` 展示当前用户网盘目录下的内容：
- 列出所有文件和子目录，显示文件名、大小、最后修改时间；
- 点击目录进入下级，支持返回上一级；
- 每个文件旁提供下载按钮；
- 自动补全路径斜杠并重定向至标准 URL。

#### 上传文件
在目录页面点击右上角“上传文件”按钮，支持选择多个文件上传：
- 实时显示文件上传进度；
- 上传完成后自动刷新当前目录；
- 支持上传到任意子目录。

## 🧪 性能评测

### 测试环境
- **操作系统**：Ubuntu 24.04.2 LTS (WSL 2)
- **编译器**：g++ 13.3.0
- **构建工具**：CMake 3.28.3
- **日志等级**：`WARNING`（减少 I/O 开销）
- **Linger 模式**：关闭（减少连接延时）

### 压测配置
- **目标地址**：`http://127.0.0.1:8080/`（首页）
- **页面大小**：808 bytes
- **并发连接数**：1000

### 测试结果
- **请求成功率**：100%
- **日志状态**：测试期间无任何 `WARNING` 或 `ERROR` 日志

### 🌐 WebBench

#### 测试配置
- **工具版本**：WebBench 1.5
- **测试命令**：
  ```bash
  webbench -c 1000 -t 10 http://127.0.0.1:8080/  
  ```
- **测试时长**：10秒

#### 测试结果
- **总请求数**：526,100
- **请求结果**：526,100 成功，0 失败
- **QPS**：52,610
- **吞吐速度**：约 45.5 MB/s
- **测试截图**：[WebBench 结果](./docs/images/webbench.png)

### ⚙️ ApacheBench

#### 测试配置
- **工具版本**：ApacheBench 2.3
- **测试命令**：
  ```bash
  ab -n 1000000 -c 1000 -q http://127.0.0.1:8080/
  ```
- **总请求数**：1,000,000

#### 测试结果
- **请求结果**：1,000,000 成功，0 失败
- **测试时长**：39.645 s
- **平均响应**：39.645 ms
- **最长响应**：55 ms
- **测试截图**：[ApacheBench 结果](./docs/images/apachebench.png)

#### 延迟分布（毫秒）
| 百分位 | 50% | 75% | 90% | 99% | 100% |
| :--: | :--: | :--: | :--: | :--: | :--: |
| 延迟 | 42 | 43 | 44 | 47 | 55 |

### 🚀 文件传输性能
- **上传速度**：约 100 MB/s
- **上传后写盘速度**：约 1 GB/s
- **下载速度**：约 200 MB/s

> 注：测试基于 WSL 环境，未通过物理网卡进行传输。结果主要反映服务端处理性能，实际性能视部署环境而定。

## 📄 开源许可

本项目基于 **[MIT License](./LICENSE)** 开源。
